<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#141414">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.PNG">

  <title>PG Daily Log</title>

  <style>
    :root{
      --bg:#0f0f0f;
      --card:#141414;
      --border:#2a2a2a;
      --muted:#a8a8a8;
      --text:#f2f2f2;
      --accent:#ff5ca8;
      --good:#22c55e;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:14px;
      --pad:16px;
      --gap:12px;
      --field:#0f0f0f;
    }

    .expWrap{ margin-top:14px; }
.expToggle{ display:flex; align-items:center; gap:10px; }
.expToggle input{ transform:scale(1.1); }

.expPanel{ display:none; margin-top:10px; }
.expPanel.show{ display:block; }

.expGrid{
  display:grid;
  grid-template-columns: 110px 1fr; /* 左SKU标签，右输入 */
  gap:12px 12px;
  align-items:center;
}
.expRow{
  display:grid;
  grid-template-columns: 110px 1fr; /* 每行两列 */
  gap:12px;
  align-items:center;
}
.expLabel{
  color:#cfcfcf;
  font-weight:700;
  letter-spacing:.2px;
}
.expInput{
  width:100%;
}
@media (max-width:420px){
  .expRow{ grid-template-columns: 90px 1fr; }
  .expLabel{ font-size:14px; }
}

    
.skuGrid{
  display:grid;
  grid-template-columns: 1fr 220px; /* 左大右小 */
  gap:12px;
  align-items:end;
}
@media (max-width:420px){
  .skuGrid{ grid-template-columns: 1fr 170px; }
}
.closedBox .btns{ display:flex; gap:10px; justify-content:flex-start; }
.closedBox label{ margin-top:0; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b0b0b 0%, #0f0f0f 40%, #0b0b0b 100%);
      color:var(--text);
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      padding: calc(18px + env(safe-area-inset-top)) 16px 14px;
      background:rgba(10,10,10,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    header .title{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
    }

    main{padding:16px; max-width: 860px; margin: 0 auto 28px;}

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin: 12px 0;
    }
    .card h2{
      margin:0 0 10px;
      font-size:20px;
      font-weight:800;
    }
    .subline{
      margin: 0 0 10px;
      color:var(--muted);
      font-size:13px;
    }
    .divider{
      height:1px;
      background:rgba(255,255,255,.07);
      margin: 12px 0;
    }

    label{
      display:block;
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
    }

    input:not([type="checkbox"]):not([type="radio"]), select, textarea{
      width:100%;
      margin-top:6px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--field);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:70px; resize:vertical}

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:end;
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      align-items:end;
    }
    @media (max-width: 560px){
      .row2,.row3{grid-template-columns:1fr}
    }

    /* Shift buttons */
    .shiftWrap{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .pill{
      border:1px solid rgba(255,255,255,.10);
      background:#101010;
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      border-color: rgba(255,92,168,.55);
      box-shadow: 0 0 0 3px rgba(255,92,168,.12) inset;
    }

    /* Focus SKU */
    .skuBlock{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:14px;
      margin-top:12px;
      background:rgba(0,0,0,.18);
    }
    .skuTitle{
      font-size:18px;
      font-weight:800;
      margin:0 0 10px;
    }
    .focusGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 560px){
      .focusGrid{grid-template-columns:1fr}
    }

    .seg{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:6px;
    }
    .seg label{margin:0; font-size:13px; color:var(--muted)}
    .seg .segBtns{
      display:flex;
      gap:8px;
    }
    .segBtn{
      border:1px solid rgba(255,255,255,.12);
      background:#0f0f0f;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      min-width:72px;
      text-align:center;
    }
    .segBtn.active{
      border-color: rgba(255,92,168,.55);
      box-shadow: 0 0 0 3px rgba(255,92,168,.12) inset;
    }

    /* Delivery expiry */
    .hint{color:var(--muted); font-size:13px; margin: 6px 0 10px;}
    .deliveryRow{
      display:grid;
      grid-template-columns: 140px 1fr 140px 1fr;
      gap:10px;
      align-items:end;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .deliveryRow:last-child{border-bottom:none}
    .deliveryLabel{
      font-weight:800;
      color:var(--text);
      opacity:.92;
      padding-top:8px;
    }
    .expLabel{
      color:var(--accent);
      font-weight:800;
      font-size:13px;
      padding-top:8px;
    }
    @media (max-width: 720px){
      .deliveryRow{
        grid-template-columns: 110px 1fr;
      }
      .expLabel{padding-top:0}
    }

    /* Checklist */
    .checkItem{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:14px;
      margin-top:12px;
      background:rgba(0,0,0,.18);
    }

    .checkHeader{
      display:grid;
      grid-template-columns: 28px 1fr;
      gap:10px;
      align-items:start;
    }

    .checkMain{
      width:22px;
      height:22px;
      margin-top:2px;
      accent-color: #3b82f6;
    }

    .checkTitleRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .checkTitle{
      font-size:22px;
      font-weight:900;
      margin:0;
      line-height:1.1;
    }
    .status{
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
    }

    .detailsBox{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.14);
    }
    .detailsHead{
      color:var(--muted);
      font-size:13px;
      margin:0 0 10px;
      font-weight:700;
    }

    .detailsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .detailsGrid{grid-template-columns:1fr}
    }

    .dRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#0f0f0f;
    }
    .dRow input[type="checkbox"]{
      width:18px;
      height:18px;
      margin:0;
      flex:0 0 auto;
      accent-color:#e5e7eb;
    }
    .dRow span{
      color:var(--text);
      font-size:14px;
      line-height:1.2;
    }

    .inlineBlock{
      margin-top:10px;
      display:grid;
      grid-template-columns: 28px 1fr;
      gap:10px;
      align-items:center;
    }
    .inlineBlock input[type="checkbox"]{
      width:18px; height:18px; margin:0;
      accent-color:#e5e7eb;
    }
    .inlineBlock .inlineLabel{
      font-size:14px;
      color:var(--text);
      font-weight:800;
    }

    .noteInput{
      margin-top:8px;
    }

    /* Cash */
    .cashGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 560px){
      .cashGrid{grid-template-columns:1fr}
    }
    .diffRow{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:#0f0f0f;
    }
    .diffLabel{
      color:var(--muted);
      font-size:13px;
      font-weight:800;
    }
    .diffValue{
      font-size:16px;
      font-weight:900;
      color:var(--accent);
    }

    /* Footer buttons */
    .btnRow{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .btn{
      flex:1;
      border:none;
      border-radius:14px;
      padding:14px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .btn.secondary{
      background:#232323;
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      flex: .7;
    }
    .btn.primary{
      background:var(--good);
      color:#041006;
      box-shadow: 0 10px 22px rgba(34,197,94,.22);
    }
    .smallHelp{
      margin-top:10px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <header>
    <div class="title">PG Daily Log</div>
  </header>

  <main>
    <!-- Opening card -->
    <section class="card" id="topCard">
      <h2>Opening</h2>

      <div class="row2">
        <div>
          <label for="store">Store</label>
          <select id="store">
            <option value="490 Bergen St">490 Bergen St</option>
            <option value="1562 1st Ave">1562 1st Ave</option>
          </select>
        </div>

        <div>
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="name">Name</label>
          <input id="name" type="text" placeholder="" autocomplete="off" />
          <div class="smallHelp">Name is saved on this phone automatically.</div>
        </div>

        <div>
          <label>Shift</label>
          <div class="shiftWrap" role="group" aria-label="Shift">
            <div class="pill" data-shift="opening">Opening (09:40–11:00)</div>
            <div class="pill" data-shift="mid">12–5pm (12:00–17:00)</div>
            <div class="pill" data-shift="closing">Closing (19:40–21:20)</div>
          </div>
        </div>
      </div>

      <div class="smallHelp">
        Tap <b>Submit &amp; Send</b> at the end of the shift. WhatsApp will open with the message pre-filled to the team.
      </div>
    </section>

    <!-- Focus SKUs -->
    <section class="card">
      <h2>Focus SKUs (record only)</h2>

      <div class="skuBlock">
        <div class="skuTitle">SKU 1</div>
        <div class="focusGrid">
          <div>
            <label for="fp1_reco">Recommend Times</label>
            <input id="fp1_reco" type="number" inputmode="numeric" min="0" value="0" />
          </div>

          <div>
            <label>Closed</label>
            <div class="seg">
              <div class="segBtns" data-seg="fp1_closed">
                <div class="segBtn active" data-val="No">No</div>
                <div class="segBtn" data-val="Yes">Yes</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="skuBlock">
        <div class="skuTitle">SKU 2</div>
        <div class="focusGrid">
          <div>
            <label for="fp2_reco">Recommend Times</label>
            <input id="fp2_reco" type="number" inputmode="numeric" min="0" value="0" />
          </div>

          <div>
            <label>Closed</label>
            <div class="seg">
              <div class="segBtns" data-seg="fp2_closed">
                <div class="segBtn active" data-val="No">No</div>
                <div class="segBtn" data-val="Yes">Yes</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="skuBlock">
        <div class="skuTitle">SKU 3</div>
        <div class="focusGrid">
          <div>
            <label for="fp3_reco">Recommend Times</label>
            <input id="fp3_reco" type="number" inputmode="numeric" min="0" value="0" />
          </div>

          <div>
            <label>Closed</label>
            <div class="seg">
              <div class="segBtns" data-seg="fp3_closed">
                <div class="segBtn active" data-val="No">No</div>
                <div class="segBtn" data-val="Yes">Yes</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Delivery expiry check -->
    <div class="card expWrap">
  <div class="h2">Today's delivery expiry check</div>
  <div class="sub">Only if you found items with EXP ≤ 8 months.</div>

  <label class="expToggle">
    <input type="checkbox" id="exp_hasIssue">
    <span>Found items with EXP ≤ 8 months</span>
  </label>

  <div id="exp_panel" class="expPanel">
    <div class="expRow" style="margin-top:10px;">
      <div class="expLabel">SKU</div>
      <div class="expLabel">EXP</div>
    </div>

    <!-- 5 rows, each row = 2 columns -->
    <div class="expRow">
      <div class="expLabel">SKU 1</div>
      <input class="expInput" id="exp_sku1" placeholder="" autocomplete="off">
      <div class="expLabel" style="display:none;"></div>
    </div>

    <div class="expRow">
      <div class="expLabel">SKU 2</div>
      <input class="expInput" id="exp_sku2" placeholder="" autocomplete="off">
      <div class="expLabel" style="display:none;"></div>
    </div>

    <div class="expRow">
      <div class="expLabel">SKU 3</div>
      <input class="expInput" id="exp_sku3" placeholder="" autocomplete="off">
      <div class="expLabel" style="display:none;"></div>
    </div>

    <div class="expRow">
      <div class="expLabel">SKU 4</div>
      <input class="expInput" id="exp_sku4" placeholder="" autocomplete="off">
      <div class="expLabel" style="display:none;"></div>
    </div>

    <div class="expRow">
      <div class="expLabel">SKU 5</div>
      <input class="expInput" id="exp_sku5" placeholder="" autocomplete="off">
      <div class="expLabel" style="display:none;"></div>
    </div>

    <div class="hint" style="margin-top:8px; opacity:.8;">
      Format example: 2026-10-15 or Oct 15, 2026
    </div>
  </div>
</div>


    <!-- Checklist -->
    <section class="card">
      <h2>Checklist</h2>

      <!-- Environment -->
      <div class="checkItem">
        <div class="checkHeader">
          <input class="checkMain" type="checkbox" id="env_main" />
          <div>
            <div class="checkTitleRow">
              <div class="checkTitle">Environment Normal</div>
            </div>
            <div class="status" id="env_status">Not done</div>

            <div class="detailsBox">
              <div class="detailsHead">Details (check if issue)</div>
              <div class="detailsGrid" id="env_details">
                <label class="dRow"><input type="checkbox" data-detail="env" value="Music issue"><span>Music issue</span></label>
                <label class="dRow"><input type="checkbox" data-detail="env" value="Lights issue"><span>Lights issue</span></label>
                <label class="dRow"><input type="checkbox" data-detail="env" value="AC/Heat issue"><span>AC/Heat issue</span></label>
              </div>

              <div class="inlineBlock" style="margin-top:12px;">
                <input type="checkbox" id="label_missing_chk" />
                <div class="inlineLabel">Label missing</div>
              </div>
              <div class="noteInput">
                <input id="label_missing_text" type="text" placeholder="eg, FD duck head, poop bag, etc" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- System -->
      <div class="checkItem">
        <div class="checkHeader">
          <input class="checkMain" type="checkbox" id="sys_main" />
          <div>
            <div class="checkTitleRow">
              <div class="checkTitle">System Normal</div>
            </div>
            <div class="status" id="sys_status">Not done</div>

            <div class="detailsBox">
              <div class="detailsHead">Details (check if issue)</div>
              <div class="detailsGrid" id="sys_details">
                <label class="dRow"><input type="checkbox" data-detail="sys" value="Phone issue"><span>Phone issue</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sys" value="WiFi issue"><span>WiFi issue</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sys" value="POS issue"><span>POS issue</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sys" value="Printer issue"><span>Printer issue</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sys" value="Receipt printer issue"><span>Receipt printer issue</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sys" value="Barcode scanner issue"><span>Barcode scanner issue</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cleaning -->
      <div class="checkItem">
        <div class="checkHeader">
          <input class="checkMain" type="checkbox" id="clean_main" />
          <div>
            <div class="checkTitleRow">
              <div class="checkTitle">Cleaning Check</div>
            </div>
            <div class="status" id="clean_status">Not done</div>

            <div class="detailsBox">
              <div class="detailsHead">Details (check if issue)</div>
              <div class="detailsGrid" id="clean_details">
                <label class="dRow"><input type="checkbox" data-detail="clean" value="Window not clean"><span>Window not clean</span></label>
                <label class="dRow"><input type="checkbox" data-detail="clean" value="Floor not clean"><span>Floor not clean</span></label>
                <label class="dRow"><input type="checkbox" data-detail="clean" value="Restroom not clean"><span>Restroom not clean</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bin, Shelf & Freezer Ready -->
      <div class="checkItem">
        <div class="checkHeader">
          <input class="checkMain" type="checkbox" id="bsf_main" />
          <div>
            <div class="checkTitleRow">
              <div class="checkTitle">Bin, Shelf &amp; Freezer Ready</div>
            </div>
            <div class="status" id="bsf_status">Not done</div>

            <div class="detailsBox">
              <div class="detailsHead">Details (check if issue)</div>
              <div class="detailsGrid" id="bsf_details">
                <label class="dRow"><input type="checkbox" data-detail="bsf" value="Restock needed"><span>Restock needed</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Supplies Check -->
      <div class="checkItem">
        <div class="checkHeader">
          <input class="checkMain" type="checkbox" id="sup_main" />
          <div>
            <div class="checkTitleRow">
              <div class="checkTitle">Supplies Check</div>
            </div>
            <div class="status" id="sup_status">Not done</div>

            <div class="detailsBox">
              <div class="detailsHead">Details (check if issue)</div>
              <div class="detailsGrid" id="sup_details">
                <label class="dRow"><input type="checkbox" data-detail="sup" value="Receipt paper ≤ 3 rolls"><span>Receipt paper ≤ 3 rolls</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sup" value="Printer cartridge ≤ 15%"><span>Printer cartridge ≤ 15%</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sup" value="Price label ≤ 1 roll"><span>Price label ≤ 1 roll</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sup" value="Fabuloso need it next week"><span>Fabuloso need it next week</span></label>
                <label class="dRow"><input type="checkbox" data-detail="sup" value="Trash Bag = 1 roll"><span>Trash Bag = 1 roll</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trash Out (NO details) -->
      <div class="checkItem">
        <div class="checkHeader">
          <input class="checkMain" type="checkbox" id="trash_main" />
          <div>
            <div class="checkTitleRow">
              <div class="checkTitle">Trash Out</div>
            </div>
            <div class="status" id="trash_status">Not done</div>
            <!-- no details box -->
          </div>
        </div>
      </div>
    </section>

    <!-- Cash -->
    <section class="card">
      <h2>Cash</h2>

      <div class="cashGrid">
        <div>
          <label for="drawerCash">Drawer Cash ($)</label>
          <input id="drawerCash" type="number" inputmode="decimal" placeholder="" />
        </div>

        <div>
          <label for="systemCashSales">System Cash Sales ($)</label>
          <input id="systemCashSales" type="number" inputmode="decimal" placeholder="" />
        </div>
      </div>

      <div class="diffRow">
        <div class="diffLabel">Difference (Drawer - System)</div>
        <div class="diffValue" id="differenceValue">$0.00</div>
      </div>

      <div class="btnRow">
        <button class="btn secondary" type="button" id="btnBack">Back</button>
        <button class="btn primary" type="button" id="btnSend">Submit &amp; Send (WhatsApp)</button>
      </div>
    </section>
  </main>

  <script>
    
    // ---------------------------
    // Helpers
    // ---------------------------
    const WA_PHONE = "12122894416"; // Olivia WhatsApp number, digits only
    const LS_NAME_KEY = "pg_dl_name_v1";
    const LS_SHIFT_KEY = "pg_dl_shift_v1";

    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatTime(d){
      try{
        const h = d.getHours();
        const m = d.getMinutes();
        const ampm = h >= 12 ? "PM" : "AM";
        const hh = h % 12 || 12;
        return `${hh}:${pad2(m)} ${ampm}`;
      }catch(e){
        return "";
      }
    }
    function escapeText(s){
      return (s ?? "").toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }
    function toNum(v){
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : 0;
    }

    // ---------------------------
    // Init date + name persistence
    // ---------------------------
    const $date = document.getElementById("date");
    const $name = document.getElementById("name");
    const $store = document.getElementById("store");

    // default date = today (local)
    (function(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = pad2(now.getMonth()+1);
      const dd = pad2(now.getDate());
      $date.value = `${yyyy}-${mm}-${dd}`;
    })();

    // load saved name
    const savedName = localStorage.getItem(LS_NAME_KEY);
    if(savedName) $name.value = savedName;

    $name.addEventListener("input", () => {
      localStorage.setItem(LS_NAME_KEY, $name.value.trim());
    });

    // ---------------------------
    // Shift selection
    // ---------------------------
    const shiftButtons = Array.from(document.querySelectorAll(".pill[data-shift]"));
    function setShift(s){
      shiftButtons.forEach(b => b.classList.toggle("active", b.dataset.shift === s));
      localStorage.setItem(LS_SHIFT_KEY, s || "");
    }
    const savedShift = localStorage.getItem(LS_SHIFT_KEY) || "";
    if(savedShift) setShift(savedShift);

    shiftButtons.forEach(btn => {
      btn.addEventListener("click", () => setShift(btn.dataset.shift));
    });

    // ---------------------------
    // Focus SKU segmented (Yes/No)
    // ---------------------------
    const segGroups = Array.from(document.querySelectorAll(".segBtns[data-seg]"));
    const segState = {
      fp1_closed: "No",
      fp2_closed: "No",
      fp3_closed: "No"
    };

    function setSeg(groupKey, val){
      segState[groupKey] = val;
      const wrap = document.querySelector(`.segBtns[data-seg="${groupKey}"]`);
      if(!wrap) return;
      Array.from(wrap.querySelectorAll(".segBtn")).forEach(b => {
        b.classList.toggle("active", b.dataset.val === val);
      });
    }
    segGroups.forEach(wrap => {
      const key = wrap.dataset.seg;
      // init default "No"
      setSeg(key, "No");
      wrap.addEventListener("click", (e) => {
        const btn = e.target.closest(".segBtn");
        if(!btn) return;
        setSeg(key, btn.dataset.val);
      });
    });

    // ---------------------------
    // Checklist status text (English only)
    // ---------------------------
    const mainChecks = [
      ["env_main", "env_status"],
      ["sys_main", "sys_status"],
      ["clean_main", "clean_status"],
      ["bsf_main", "bsf_status"],
      ["sup_main", "sup_status"],
      ["trash_main", "trash_status"]
    ];

    function updateStatus(mainId, statusId){
      const main = document.getElementById(mainId);
      const st = document.getElementById(statusId);
      if(!main || !st) return;

      if(main.checked){
        const now = new Date();
        st.textContent = `Completed at ${formatTime(now)}`;
        st.dataset.completedAt = now.toISOString();
      }else{
        st.textContent = "Not done";
        delete st.dataset.completedAt;
      }
    }

    mainChecks.forEach(([m,s]) => {
      const el = document.getElementById(m);
      if(!el) return;
      el.addEventListener("change", () => updateStatus(m,s));
      updateStatus(m,s);
    });

    // Label missing checkbox + input (keep placeholder in UI, but WhatsApp should show blank if empty)
    const labelMissingChk = document.getElementById("label_missing_chk");
    const labelMissingText = document.getElementById("label_missing_text");
    labelMissingChk.addEventListener("change", () => {
      // If unchecked, do not clear text (you wanted accountability); keep text as is.
      // If they typed but didn't check, you will see that mismatch.
    });

    // ---------------------------
    // Cash auto difference
    // ---------------------------
    const $drawer = document.getElementById("drawerCash");
    const $system = document.getElementById("systemCashSales");
    const $diff = document.getElementById("differenceValue");

    function updateDifference(){
      const drawer = toNum($drawer.value);
      const system = toNum($system.value);
      const diff = drawer - system;
      $diff.textContent = `$${diff.toFixed(2)}`;
      $diff.dataset.value = diff.toFixed(2);
    }
    $drawer.addEventListener("input", updateDifference);
    $system.addEventListener("input", updateDifference);
    updateDifference();

    // ---------------------------
    // Build WhatsApp message
    // (No "blank" anywhere; empty stays empty)
    // ---------------------------
    function getShiftLabel(){
      const active = shiftButtons.find(b => b.classList.contains("active"));
      if(!active) return "";
      const s = active.dataset.shift;
      if(s === "opening") return "Opening";
      if(s === "mid") return "12–5pm";
      if(s === "closing") return "Closing";
      return "";
    }

    function listCheckedDetails(detailKey){
      const nodes = Array.from(document.querySelectorAll(`input[type="checkbox"][data-detail="${detailKey}"]`));
      const vals = nodes.filter(n => n.checked).map(n => n.value);
      return vals;
    }

    function buildMessage(){
      const store = $store.value || "";
      const date = $date.value || "";
      const name = ($name.value || "").trim();
      const shift = getShiftLabel();

      const fp = [
        {sku:"SKU 1", reco: document.getElementById("fp1_reco").value ?? "0", closed: segState.fp1_closed},
        {sku:"SKU 2", reco: document.getElementById("fp2_reco").value ?? "0", closed: segState.fp2_closed},
        {sku:"SKU 3", reco: document.getElementById("fp3_reco").value ?? "0", closed: segState.fp3_closed},
      ];

      const expHasIssue = document.getElementById("exp_hasIssue")?.checked;

const delivery = [1,2,3,4,5].map(i => ({
  sku: `SKU ${i}`,
  exp: (document.getElementById(`exp_sku${i}`)?.value || "").trim()
}));

      const envDetails = listCheckedDetails("env");
      const sysDetails = listCheckedDetails("sys");
      const cleanDetails = listCheckedDetails("clean");
      const bsfDetails = listCheckedDetails("bsf");
      const supDetails = listCheckedDetails("sup");

      const envDone = document.getElementById("env_main").checked;
      const sysDone = document.getElementById("sys_main").checked;
      const cleanDone = document.getElementById("clean_main").checked;
      const bsfDone = document.getElementById("bsf_main").checked;
      const supDone = document.getElementById("sup_main").checked;
      const trashDone = document.getElementById("trash_main").checked;

      const labelMissingChecked = labelMissingChk.checked;
      const labelMissingVal = (labelMissingText.value || "").trim(); // if empty -> empty

      const drawer = ($drawer.value || "").trim();
      const systemSales = ($system.value || "").trim();
      const diffVal = $diff.dataset.value ?? "";

      const lines = [];

      // Header
      lines.push(`PG Daily Log`);
      lines.push(`Store: ${store}`);
      lines.push(`Date: ${date}`);
      lines.push(`Name: ${name}`);
      lines.push(`Shift: ${shift}`);
      lines.push(``);

      // Focus SKUs
      lines.push(`Focus SKUs`);
      fp.forEach(x => {
        const reco = (x.reco === "" ? "0" : x.reco);
        lines.push(`${x.sku} — Recommend: ${reco} | Closed: ${x.closed}`);
      });
      lines.push(``);

      // Delivery
      lines.push(`Delivery Expiry Check (if < 8 months)`);
      delivery.forEach((d, idx) => {
        const skuLabel = `SKU ${idx+1}`;
        lines.push(`${skuLabel}: ${d.sku} | EXP: ${d.exp}`);
      });
      lines.push(``);

      // Checklist summary
      function doneText(b){ return b ? "Done" : "Not done"; }

      lines.push(`Checklist`);
      lines.push(`Environment Normal: ${doneText(envDone)}`);
      if(envDetails.length) lines.push(`- Issues: ${envDetails.join(", ")}`);
      // Label missing line must appear in WhatsApp always
      lines.push(`- Label missing checked: ${labelMissingChecked ? "Yes" : "No"}`);
      lines.push(`- Label missing: ${labelMissingVal}`); // empty stays empty

      lines.push(`System Normal: ${doneText(sysDone)}`);
      if(sysDetails.length) lines.push(`- Issues: ${sysDetails.join(", ")}`);

      lines.push(`Cleaning Check: ${doneText(cleanDone)}`);
      if(cleanDetails.length) lines.push(`- Issues: ${cleanDetails.join(", ")}`);

      lines.push(`Bin, Shelf & Freezer Ready: ${doneText(bsfDone)}`);
      if(bsfDetails.length) lines.push(`- Issues: ${bsfDetails.join(", ")}`);

      lines.push(`Supplies Check: ${doneText(supDone)}`);
      if(supDetails.length) lines.push(`- Issues: ${supDetails.join(", ")}`);

      lines.push(`Trash Out: ${doneText(trashDone)}`);
      lines.push(``);

      // Cash
      lines.push(`Cash`);
      lines.push(`Drawer Cash: ${drawer}`);
      lines.push(`System Cash Sales: ${systemSales}`);
      lines.push(`Difference (Drawer - System): ${diffVal}`);

      return lines.join("\n");
    }

    function openWhatsApp(){
      const msg = buildMessage();
      const url = `https://wa.me/${WA_PHONE}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }

    // Back button (scroll to top)
    document.getElementById("btnBack").addEventListener("click", () => {
      window.scrollTo({top: 0, behavior: "smooth"});
    });

    document.getElementById("btnSend").addEventListener("click", openWhatsApp);

    // ---------------------------
    // Service worker (optional)
    // ---------------------------
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
